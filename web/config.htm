<!--
*******************************************************************
***   Kristian's Stargate Project - TheStargateProject.com      ***
*******************************************************************
***                                                             ***
***   Original Software written by Kristian Tysse               ***
***   Restructuring and Development by Jonathan Moyes           ***
***   Web Interface adapted from Dan Clarke:                    ***
***      https://github.com/danclarke/WorkingStargateMk2Raspi   ***
***                                                             ***
*******************************************************************
-->
<html>
    <head>
        <meta charset="UTF-8">
        <title>Stargate Command</title>
        <link rel="stylesheet" href="lib/jquery-ui-1.13.0.custom/jquery-ui.css">
        <link rel="stylesheet" href="main.css" />
        <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>

        <style>
        .button, .cycleChevronButton {margin:10px;}

        </style>

        <script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="lib/jquery-ui-1.13.0.custom/jquery-ui.js"></script>
    </head>
    <body>

    <script type="text/javascript" >

      // Configuration
      var poll_delay_default = 5000
      var poll_delay_offline = 500

      // State variables
      var poll_delay = poll_delay_default

      var offline_modal = $('<div id="offline-modal" title="Stargate is Offline"><span id="dialogMsg">Unable to communicate with the Stargate. <br><br>Ensure that the Stargate software is running.</span></div>');
      offline_modal.dialog({
      		autoOpen: false,
      		modal: true,
      		dialogClass: "no-close",
      });

      $( function() {
        doPoll();
        updateInfo();


      }); // End of on-ready function

      var is_online = true
      function doPoll( singleShot = false ){
        $.get('stargate/get/is_alive')
          .done(function(data) {
            // Hide the offline modal
            hideOfflineModal()

            // If we're recovering from being offline, refresh
            if (!is_online){
              updateInfo()
            }
            is_online = true

            poll_delay = poll_delay_default

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            // Show the "we're offline modal"
            showOfflineModal()
            is_online = false


            // Slow the polling rate to default
            poll_delay = poll_delay_offline

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          }); // End $.get
      }

      function updateInfo(){

        $.ajax({
            url: '/stargate/get/config',
            success: function (response) {
                var trHTML = '';
                $.each(response, function (paramName, item) {
                    trHTML += '<tr><td>' + toProperCase(paramName) + '</td><td>' + item.type + '</td><td>' + item.value + '</td><td>' + item.desc + '</td></tr>';
                });
                $('#records_table').append(trHTML);
            }
        });
      }

      function toProperCase(str){
        str = str.replace(/_/g, " "); // Replace underscores with spaces

        // Capitalize first letter of each word
        const words = str.split(" ");
        for (let i = 0; i < words.length; i++) {
            words[i] = words[i][0].toUpperCase() + words[i].substr(1);
        }
        return words.join(" ");
      }

      function showOfflineModal(){
        offline_modal.dialog("open");
      }

      function hideOfflineModal(){
        offline_modal.dialog("close");
      }

    </script>

    <table id="records_table" border='1'>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Value</th>
            <th>Description</th>
        </tr>
    </table>

    <div class='div-table'>
      <div class="div-table-row"><span class="div-table-col-names">Stargate Name:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="gateName">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Software Version:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareVersion">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Status:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareUpdateStatus">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Last Checked:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareUpdateTime">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Python Version:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="pythonVersion">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Local Stargate Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="localStargateAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace Status:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="subspaceStatus">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace Public Key:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="publicKey">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace IP Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="subspaceIPAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Internet Connection:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="hasInternet">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">LAN IP Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="lanIPAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Known Standard Gates:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="standardGateCount">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Known Fan Gates:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="fanGateCount">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Last Updated:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="fanGateLastUpdate">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Dialer Mode:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="dialerMode">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Hardware in Use:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="hardwareMode">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Audio Volume (%):&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="volumeAsPercent">Loading...</span></div>
    </div>

    <hr />

    <div class="controls">
        <div class="control" onclick="window.location = 'testing.htm';">
            Testing / Debug
        </div>
        <div class="control" onclick="window.location = 'info.htm';">
            System<br>Info
        </div>
         <div class="control" onclick="window.location = 'index.htm';">
            Dialing <br> page
        </div>
    </div>
  </body>
</html>
