<!--
*******************************************************************
***   Kristian's Stargate Project - TheStargateProject.com      ***
*******************************************************************
***                                                             ***
***   Original Software written by Kristian Tysse               ***
***   Restructuring and Development by Jonathan Moyes           ***
***                                                             ***
*******************************************************************
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Jonathan Moyes">
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>

    <title>Address Book | Stargate Command</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="lib/jquery-ui-1.13.0.custom/jquery-ui.css">
    <link href="lib/bootstrap-4.0.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="lib/jquery-ui-1.13.0.custom/jquery-ui.js"></script>

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="main.css" />

  </head>

  <body>

    <script type="text/javascript">

    // Configuration
    var poll_delay_default = 5000
    var poll_delay_offline = 500

    // State variables
    var poll_delay = poll_delay_default
    var is_online = false

    var offline_modal = $('<div id="offline-modal" title="Stargate is Offline"><span id="dialogMsg">Unable to communicate with the Stargate. <br><br>Ensure that the Stargate software is running.</span></div>');
    offline_modal.dialog({
        autoOpen: false,
        modal: true,
        dialogClass: "no-close",
    });

    // This function is run on document-ready
    $( function() {
        doPoll()
    })

    function update_address_book(){
      $.ajax({
          dataType: "json",
          url: "/stargate/get/address_book",
          data: {
              type: "all"
          },
          success: function( json ) {
              addresses = json['address_book']
              galaxy_path = json['galaxy_path']
              load_address_book()
          },
          error: function (xhr, textStatus, errorThrown){
              console.log("Failed to load Address Book from Stargate")
              $("<div>Failed to load Address Book from Stargate</div>").dialog();
          }

      });
    }
    function load_address_book(){
        $.each(addresses, function( index, value ) {
            address_raw = value.gate_address
            address_string = address_raw.join("-");
            $.each(address_raw, function( index, value) {
                value=("000" + value).substr(-3,3);
                address_raw[index] = '<img class="address-book-glyph" src="chevrons/'+galaxy_path+'/'+value+'.svg" />';
            });

            address = address_raw.join("");

            $("#presets").append('<div class="address-book-row address-book-row-'+value.type+'" onclick="window.location = \'index.htm?address=' +
              address_string + '\';"><div class="address-book-col-planet-names">' + value.name + '</div><div class="address-book-col-glyphs">' + address +  '</div></div>' );
        });
    }

    function doPoll( singleShot = false ){
        $.get('stargate/get/is_alive')
            .done(function(data) {
                // If we're coming back from being offline, update the address book
                if (!is_online){
                  update_address_book()
                }

                // Hide the offline modal
                hideOfflineModal()

                poll_delay = poll_delay_default
                is_online = true
                // Schedule the next polling
                if ( !singleShot ){
                    setTimeout(function(){doPoll( false ); }, poll_delay);
                }
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                // Show the "we're offline modal"
                showOfflineModal()
                is_online = false
                // Slow the polling rate to default
                poll_delay = poll_delay_offline

                // Schedule the next polling
                if ( !singleShot ){
                    setTimeout(function(){doPoll( false ); }, poll_delay);
                }
            }

        );

    }

    function showOfflineModal(){
        offline_modal.dialog("open");
    }

    function hideOfflineModal(){
        offline_modal.dialog("close");
    }

    </script>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="#">Stargate Command</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.htm">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="#">Address Book <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Admin</a>
            <div class="dropdown-menu" aria-labelledby="dropdown01">
              <a class="dropdown-item" href="debug.htm">Testing / Debug</a>
              <a><hr></a>
              <a class="dropdown-item" href="config.htm">Configuration</a>
              <a class="dropdown-item" href="info.htm">System Information</a>
              <a><hr></a>
              <a class="dropdown-item" href="#">Restart Software</a>
              <a class="dropdown-item" href="#">Reboot Raspberry Pi</a>
              <a class="dropdown-item" href="#">Shutdown Raspberry Pi</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <img src="img/header.jpg" style="alignment: center" width="100%" alt="header_image">

    <main role="main" class="container">

      <div class="starter-template">

        <div id="presets">
            <!-- This div will be populated with entries from the API-sourced AddressBook -->
        </div>

      </div>

    </main><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script>window.jQuery || document.write('<script src="/lib/bootstrap-4.0.0/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="/lib/bootstrap-4.0.0/assets/js/vendor/popper.min.js"></script>
    <script src="/lib/bootstrap-4.0.0/dist/js/bootstrap.min.js"></script>
  </body>
</html>
