<html>
    <head>
        <meta charset="UTF-8">
        <title>Stargate Command</title>
        <link rel="stylesheet" href="lib/jquery-ui-1.13.0.custom/jquery-ui.css">
        <link rel="stylesheet" href="main.css" />
        <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>

        <style>
        .button, .cycleChevronButton {margin:10px;}

        .dd-selected-image, .dd-option-image {
        	max-height: 25px !important;
        }

        label.dd-selected-text {
           line-height: 20px !important;

        }
        a.dd-selected, a.dd-option-description {
        	color: black;
        }

        input[type='number']{
            width:150px;
        }

        #lcl_addr_image_container img{
          max-height: 40px;
          filter: invert(1);
        }

        #lcl_addr_image_container, #localStargateAddress{
          display: inline-flex;
          align-items: center;
        }

        </style>

        <script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="lib/jquery-ui-1.13.0.custom/jquery-ui.js"></script>
        <script type="text/javascript" src="lib/jquery.ddslick.min.js"></script>
    </head>
    <body>

    <script type="text/javascript" >

      // Configuration
      var poll_delay_default = 5000
      var poll_delay_offline = 500

      // State variables
      var poll_delay = poll_delay_default

      var offline_modal = $('<div id="offline-modal" title="Stargate is Offline"><span id="dialogMsg">Unable to communicate with the Stargate. <br><br>Ensure that the Stargate software is running.</span></div>');
      offline_modal.dialog({
      		autoOpen: false,
      		modal: true,
      		dialogClass: "no-close",
      });

      $( function() {
        doPoll();
        updateInfo();

        var dialog, form, dialog_ss_ip, form_ss_ip

            // From http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#e-mail-state-%28type=email%29
            symbol_1 = $( "#symbol_1" ),
            symbol_2 = $( "#symbol_2" ),
            symbol_3 = $( "#symbol_3" ),
            symbol_4 = $( "#symbol_4" ),
            symbol_5 = $( "#symbol_5" ),
            symbol_6 = $( "#symbol_6" ),
            allFields = $( [] ).add( symbol_1 ).add( symbol_2 ).add( symbol_3 ).add( symbol_4 ).add( symbol_5 ).add( symbol_6 ),

            subspace_ip_input = $( "#subspace_ip_input" ),
            allFields_ss_ip = $( [] ).add( subspace_ip_input ),

            tips = $( ".validateTips" );

        function updateTips( t ) {
          tips.text( t ).addClass( "ui-state-highlight" );
          setTimeout(function() {
              tips.removeClass( "ui-state-highlight", 1500 );
          }, 500 );
        }

        function checkIPAddress( o, n ){
          // Check if blank
          if (o.val() == ""){
            o.addClass( "ui-state-error" );
            updateTips( n + " is required");
            return false
          }

          // Check if valid
          if (!(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test( o.val() ) ) ) {
            o.addClass( "ui-state-error" );
            updateTips( n + " entered is not valid");
            return false
          }

          // If we get here, it's valid
          return true
        }

        function checkSymbol( o, n, min, max ) {
          // Check if blank
          if (o.val() == ""){
            o.addClass( "ui-state-error" );
            updateTips( n + " is required");
            return false
          }

          // Check in range
          if ( o.val() > max || o.val() < min ) {
            o.addClass( "ui-state-error" );
            updateTips( "Value of " + n + " must be between " +
                min + " and " + max + "." );
            return false;
          }

          // If we get here, it's valid
            return true;
        }

        function validateAndSaveSubspaceAddress(){
          allFields_ss_ip.removeClass( "ui-state-error" );

          if ( checkIPAddress( subspace_ip_input, "Subspace IP" ) ) {
              // Save to API
              $.post({
                url: 'stargate/update',
                data: JSON.stringify({
                  action: 'set_subspace_ip',
                  ip: subspace_ip_input.val().toString()
                })
              })
              .done(function(data) {
                if (data['success']){
                  $("<div></div>").html( data.message ).dialog({
                      title: "CONGRATULATIONS!",
                      resizable: false,
                      modal: true,
                      buttons: {
                        'Ok': function()  {
                          $( this ).dialog( 'close' );
                        }
                      }
                  });
                  dialog_ss_ip.dialog( "close" );
                  updateInfo();
                }
                else{
                  $("<div></div>").html( data.error ).dialog({
                    title: "Error",
                    resizable: false,
                    modal: true,
                    buttons: {
                      'Ok': function()  {
                        $( this ).dialog( 'close' );
                      }
                    }
                  });
                }
              })
              .fail(function() {
                console.log("Failed to communicate with Stargate")
                $("<div>Failed to communicate with Stargate</div>").dialog();
              });
          }
        }

        function validateAndSaveLocalAddress() {
          var valid = true;
          allFields.removeClass( "ui-state-error" );
          valid = valid && checkSymbol( symbol_1, "Symbol 1", 2, 39 ); // 2-39: disallow Earth symbol.
          valid = valid && checkSymbol( symbol_2, "Symbol 2", 2, 39 ); // 2-39: disallow Earth symbol.
          valid = valid && checkSymbol( symbol_3, "Symbol 3", 2, 39 ); // 2-39: disallow Earth symbol.
          valid = valid && checkSymbol( symbol_4, "Symbol 4", 2, 39 ); // 2-39: disallow Earth symbol.
          valid = valid && checkSymbol( symbol_5, "Symbol 5", 2, 39 ); // 2-39: disallow Earth symbol.
          valid = valid && checkSymbol( symbol_6, "Symbol 6", 2, 39 ); // 2-39: disallow Earth symbol.

          if ( valid ) {
              // Save to API
              $.post({
                url: 'stargate/update',
                data: JSON.stringify({
                  action: 'set_local_stargate_address',
                  S1: parseInt(symbol_1.val()),
                  S2: parseInt(symbol_2.val()),
                  S3: parseInt(symbol_3.val()),
                  S4: parseInt(symbol_4.val()),
                  S5: parseInt(symbol_5.val()),
                  S6: parseInt(symbol_6.val())
                })
              })
              .done(function(data) {
                if (data['success']){
                  $("<div></div>").html( data.message ).dialog({
                      title: "CONGRATULATIONS!",
                      resizable: false,
                      modal: true,
                      buttons: {
                        'Ok': function()  {
                          $( this ).dialog( 'close' );
                        }
                      }
                  });
                  dialog.dialog( "close" );
                  updateInfo();
                }
                else{
                  $("<div></div>").html( data.error ).dialog({
                    title: "Error",
                    resizable: false,
                    modal: true,
                    buttons: {
                      'Ok': function()  {
                        $( this ).dialog( 'close' );
                      }
                    }
                  });
                }
              })
              .fail(function() {
                console.log("Failed to communicate with Stargate")
                $("<div>Failed to communicate with Stargate</div>").dialog();
              });
          }
          return valid;
        } // end validateAndSaveLocalAddress()

        dialog = $( "#dialog-form" ).dialog({
            autoOpen: false,
            height: 500,
            width: 350,
            modal: true,
            buttons: {
                "Validate & Save": validateAndSaveLocalAddress,
                Cancel: function() {
                    dialog.dialog( "close" );
                }
            },
            close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
            }
        });

        form = dialog.find( "form" ).on( "submit", function( event ) {
            event.preventDefault();
            validateAndSaveLocalAddress();
        });

        dialog_ss_ip = $( "#dialog-form-subspace-ip" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Validate & Save": validateAndSaveSubspaceAddress,
                Cancel: function() {
                    dialog_ss_ip.dialog( "close" );
                }
            },
            close: function() {
                form[ 0 ].reset();
                allFields_ss_ip.removeClass( "ui-state-error" );
            }
        });

        form_ss_ip = dialog_ss_ip.find( "form" ).on( "submit", function( event ) {
            event.preventDefault();
            validateAndSaveSubspaceAddress();
        });

      }); // End of on-ready function

      var symbols = [] // This array will be populated by an ajax request

      function init_pulldowns(){
        for(i=1;i<=6;i++){
          $('#symbol_' + i).ddslick({
            data:symbols,
            //width:300,
            selectText: "Symbol " + i,
            imagePosition:"right",
            onSelected: function(selectedData){
            		//callback function: do something with selectedData;
                // TODO: Disable this symbol in the other menus
            }
          }); // End ddslick init
        } // End for

      } // End init_pulldowns

      function doPoll( singleShot = false ){
        $.get('stargate/get?entity=is_alive')
          .done(function(data) {
            // Hide the offline modal
            hideOfflineModal()

            poll_delay = poll_delay_default

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            // Show the "we're offline modal"
            showOfflineModal()

            // Slow the polling rate to default
            poll_delay = poll_delay_offline

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          }); // End $.get
      }

      function updateInfo(){
        $.get('stargate/get?entity=info')
          .done(function(data) {

            // Hide the offline modal
            hideOfflineModal()

            // Update the UI
            if (data.local_stargate_address_string){

              // Display the configured local address
              $('#localStargateAddress').html("<div id='lcl_addr_image_container'></div>")

              // If we don't have a Subspace IP address configured, offer the config button
              if ( data.subspace_ip_address_config == null || data.subspace_ip_address_config == "" ){
                $('#localStargateAddress').html( $('#localStargateAddress').html() + "<button id='config-lcl-sg-addr'>Configure</button>")
              }

              // Load the current address in images
              html = ""
              for (i=0;i<6;i++){
                imageUrl = "/chevrons/" + String(data.local_stargate_address[i]).padStart(3, '0') + ".svg";
                imageHtml = "<img src='" + imageUrl + "' alt='" + data.local_stargate_address[i] + "'>"
                html += imageHtml
              }
              html += "<span style='padding: 10px;'>" + data.local_stargate_address_string + "</span>"
              $('#lcl_addr_image_container').html(html)

            }
            else{
              $('#localStargateAddress').html("<button id='config-lcl-sg-addr'>Configure</button>")
            }

            // Setup the "Configure Local Address" button on-click handler
            $( "#config-lcl-sg-addr" ).button().on( "click", function() {
              $( "#dialog-form" ).dialog( "open" );

                // Load the current address into the form
                for (i=0;i<6;i++){
                  pulldown = $('#symbol_' + (i+1).toString())
                  value = data.local_stargate_address[i]-1 // Minus 1 because these are indexes, not values we're setting.
                  setPulldownValue( pulldown, value )
                }
            });

            $('#lanIPAddress').html(data.lan_ip_address)
            $('#softwareVersion').html(data.software_version)
            $('#softwareUpdateTime').html(data.software_update_last_check)
            $('#softwareUpdateStatus').html(data.software_update_status)
            $('#pythonVersion').html(data.python_version)
            $('#fanGateLastUpdate').html(data.last_fan_gate_update)
            $('#fanGateCount').html(data.fan_gate_count)
            $('#standardGateCount').html(data.standard_gate_count)
            $('#dialerMode').html(data.dialer_mode)
            $('#hardwareMode').html(data.hardware_mode)

            if (data.subspace_public_key){
              $('#publicKey').html(data.subspace_public_key)
            }
            else{
              $('#publicKey').html("n/a")
              $('#subspaceStatus').html("Not Configured")
            }

            if (data.internet_available){
              $('#hasInternet').html("Connected")
            }
            else{
              $('#hasInternet').html("Offline")
            }

            if (data.subspace_available){
              $('#subspaceStatus').html("Connected")
            }
            else{
              $('#subspaceStatus').html("Offline")
            }

            // If we don't have a Subspace IP,
            if (!data.subspace_ip_address_config){

              // ...and we DO have a local_address configured, offer a link to email Kristian
              if (data.local_stargate_address_string){
                  emailTo = "kristian@thestargateproject.com"
                  subject = "New Stargate"
                  body = "Hi Kristian,%0d%0a%0d%0aI'd like to get a Subspace IP address for my new Stargate. Can you set that up?%0d%0a%0d%0a" +
                         "Name/planet: %3CThe name you want in the %22address book%22%3E%0d%0a" +
                         "Email address: %3CYour email address%3E%0d%0a%0d%0a" +
                         "Stargate address: " + data.local_stargate_address_string + "%0d%0a" +
                         "Public key: " + data.subspace_public_key + "%0d%0a" +
                         "%0d%0aThanks,"



                         mailLinkContent = "<a href=\"mailto:" + emailTo + "?subject=" + subject + "&body=" + body + "\">Step 1: Request Access to the Subspace Network</a>"
                         ipConfigLink = "Step 2: <button id='config-subspace-ip-addr'>Configure Subspace IP Address</button>"
                  $('#subspaceIPAddress').html(mailLinkContent + "<br>" + ipConfigLink)

                  // Setup the "Configure Subspace IP Address" button on-click handler
                  $( "#config-subspace-ip-addr" ).button().on( "click", function() {
                    $( "#dialog-form-subspace-ip" ).dialog( "open" );
                      // Load the current address into the form

                  });
              }
              else{
                 $('#subspaceIPAddress').html("Not Configured!")
              }
            }
            else{
              $('#subspaceIPAddress').html(data.subspace_ip_address_config)
            }
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            // Show the "we're offline modal"
            showOfflineModal()

            setTimeout(function(){updateInfo( false ); }, poll_delay);
          })

          // Get the symbol configs for the dropdowns
          $.get('stargate/get?entity=symbols_ddslick')
            .done(function(data) {
              symbols = data.symbols
              init_pulldowns()
          })
      }

      function setPulldownValue( pulldown, value ){
          pulldown.ddslick('select', {index: value });
      }

      function showOfflineModal(){
        offline_modal.dialog("open");
      }

      function hideOfflineModal(){
        offline_modal.dialog("close");
      }

    </script>

    <div id="dialog-form" title="Configure Local Gate Address">
      <p class="validateTips">Enter the Address you which to use.</p>
      <form>
          <fieldset>
            <div id="symbol_1"></div>
            <div id="symbol_2"></div>
            <div id="symbol_3"></div>
            <div id="symbol_4"></div>
            <div id="symbol_5"></div>
            <div id="symbol_6"></div>

            <!-- Allow form submission with keyboard without duplicating the dialog button -->
            <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
          </fieldset>
      </form>
    </div>

    <div id="dialog-form-subspace-ip" title="Configure Subspace IP Address">
      <p class="validateTips">Enter the IP address assigned to this gate by Kristian</p>
      <form>
          <fieldset>
            <input type="text" class="form-control" id="subspace_ip_input" name="subspace_ip" placeholder="Subspace IP Address"/>

            <!-- Allow form submission with keyboard without duplicating the dialog button -->
            <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
          </fieldset>
      </form>
    </div>

    <div class='div-table'>
      <div class="div-table-row"><span class="div-table-col-names">Software Version:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareVersion">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Status:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareUpdateStatus">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Last Checked:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="softwareUpdateTime">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Python Version:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="pythonVersion">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Local Stargate Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="localStargateAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace Status:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="subspaceStatus">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace Public Key:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="publicKey">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Subspace IP Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="subspaceIPAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Internet Connection:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="hasInternet">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">LAN IP Address:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="lanIPAddress">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Known Standard Gates:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="standardGateCount">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Known Fan Gates:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="fanGateCount">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">&nbsp;&nbsp;Last Updated:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="fanGateLastUpdate">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Dialer Mode:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="dialerMode">Loading...</span></div>
      <div class="div-table-row"><span class="div-table-col-names">Hardware in Use:&nbsp;&nbsp;&nbsp;</span><span class="div-table-col-values" id="hardwareMode">Loading...</span></div>
    </div>

    <hr />

    <div class="controls">
        <div class="control" onclick="window.location = 'testing.htm';">
            Testing / Debug
        </div>
         <div class="control" onclick="window.location = 'index.htm';">
            Dialing <br> page
        </div>
    </div>
  </body>
</html>
