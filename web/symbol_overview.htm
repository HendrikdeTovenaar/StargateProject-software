<!--
*******************************************************************
***   Kristian's Stargate Project - TheStargateProject.com      ***
*******************************************************************
***                                                             ***
***   Original Software written by Kristian Tysse               ***
***   Restructuring and Development by Jonathan Moyes           ***
***   Web Interface adapted from Dan Clarke:                    ***
***      https://github.com/danclarke/WorkingStargateMk2Raspi   ***
***                                                             ***
*******************************************************************
-->
<html>
    <head>
        <meta charset="UTF-8">
        <title>Stargate Command</title>
        <link rel="stylesheet" href="lib/jquery-ui-1.13.0.custom/jquery-ui.css">
        <link rel="stylesheet" href="main.css" />
        <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>

        <style>
        .button, .cycleChevronButton {margin:10px;}
        .tableRow td{
            text-align: center;
        }
        </style>

        <script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="lib/jquery-ui-1.13.0.custom/jquery-ui.js"></script>
        <script type="text/javascript" src="lib/moment.js"></script>
    </head>
    <body>

    <script type="text/javascript" >

      // Configuration
      var poll_delay_default = 5000
      var poll_delay_offline = 500

      // State variables
      var poll_delay = poll_delay_default

      var offline_modal = $('<div id="offline-modal" title="Stargate is Offline"><span id="dialogMsg">Unable to communicate with the Stargate. <br><br>Ensure that the Stargate software is running.</span></div>');
      offline_modal.dialog({
      		autoOpen: false,
      		modal: true,
      		dialogClass: "no-close",
      });

      $( function() {
        doPoll();
        updateInfo();
      }); // End of on-ready function

      var is_online = true
      function doPoll( singleShot = false ){
        $.get('stargate/get/is_alive')
          .done(function(data) {
            // Hide the offline modal
            hideOfflineModal()

            // If we're recovering from being offline, refresh
            if (!is_online){
              updateInfo()
            }
            is_online = true

            poll_delay = poll_delay_default

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            // Show the "we're offline modal"
            showOfflineModal()
            is_online = false


            // Slow the polling rate to default
            poll_delay = poll_delay_offline

            // Schedule the next polling
            if ( !singleShot ){
              setTimeout(function(){doPoll( false ); }, poll_delay);
            }
          }); // End $.get
      }

      function updateInfo(){

        $.ajax({
            url: '/stargate/get/dhd_symbols',
            success: function (response) {
              var trHTML = '';
              $.each(response, function (paramName, item) {
                  console.log(item)
                  trHTML += getHTMLTableRow(paramName, item)
              });
              $('#records_table').html("\
                  <tr>\
                      <th>Symbol Number</th>\
                      <th>Index</th>\
                      <th>Name</th>\
                      <th>Keyboard Mapping</th>\
                  </tr>");

              $('#records_table').append(trHTML);

            }
        });
      }

      function getHTMLTableRow(paramName, data){
        if (!data.units) data.units = ""
        return '<tr class="tableRow"><td><img src="' + data.imageSrc + '" height="50"/></td><td>' + data.index + '</td><td>' + data.name + '</td><td>' + data.keyboard_mapping + '</td></tr>';
      }

      function showOfflineModal(){
        offline_modal.dialog("open");
      }

      function hideOfflineModal(){
        offline_modal.dialog("close");
      }

      function getFormDataJson(form){
        form = form.serializeArray();
        var data = {};
        $(form).each(function(index, obj){
          data[obj.name] = obj.value;
        });
        return JSON.stringify(data);
      }

    </script>
    <h2>Symbol Overview</h2>
    <table id="records_table" border='1'></table>
    <hr />

    <div class="controls">
        <div class="control" onclick="window.location = 'debug.htm';">
            Testing / Debug
        </div>
        <div class="control" onclick="window.location = 'info.htm';">
            System<br>Info
        </div>
         <div class="control" onclick="window.location = 'index.htm';">
            Dialing <br> page
        </div>
    </div>
  </body>
</html>
